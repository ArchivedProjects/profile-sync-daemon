#!/bin/bash
# Profile-sync-daemon v3.0
# Updated 14-Jan-2011
# By graysky <graysky AT archlinux DOT us>
# Inspired by some code originally  written by Colin Verot

. /etc/psd.conf

# nothing to do if there are no users
[[ -z $USERS ]] && exit 0

BROWSERS=${BROWSERS:-"chromium google-chrome midori mozilla opera opera-next"} # all supported browsers

set_which() {
	local user=$1
	local browser=$2
	local homedir="$(su -c 'echo $HOME' $user)"

	# reset global variables
	STATIC=
	LINK=

	# skip homeless users
	if [[ -z $homedir ]]; then
		return
	fi

	case "$browser" in
		chromium)
			STATIC="$homedir/.config/$browser-backup"
			LINK="$homedir/.config/$browser"
			;;
		google-chrome)
			STATIC="$homedir/.config/$browser-backup"
			LINK="$homedir/.config/$browser"
			;;
		midori)
			STATIC="$homedir/.config/$browser-backup"
			LINK="$homedir/.config/$browser"
			;;
		mozilla)
			STATIC="$homedir/.$browser-backup"
			LINK="$homedir/.$browser"
			;;
		opera)
			STATIC="$homedir/.$browser-backup"
			LINK="$homedir/.$browser"
			;;
		opera-next)
			STATIC="$homedir/.$browser-backup"
			LINK="$homedir/.$browser"
			;;
		*)
			# this should never happen
			exit 1
	esac
}

sync() {
	# sync profiles to tmpfs and back again
	local browser user
	for user in $USERS; do
		for browser in $BROWSERS; do
			set_which "$user" "$browser"
			# check if user has browser profile
			if [[ -d $LINK ]]; then
				[[ -r "$VOLATILE/$user-$browser" ]] || su -c "install -dm755 '$VOLATILE/$user-$browser'" $user

				# backup profile and link to tmpfs
				if [[ $(readlink "$LINK") != "$VOLATILE/$user-$browser" ]]; then
					mv "$LINK" "$STATIC"
					ln -s "$VOLATILE/$user-$browser" "$LINK"
				fi

				# sync the RAM profile to the disc
				if [[ -e $LINK/.flagged ]]; then
					su -c "rsync -a --delete --exclude .flagged '$LINK/' '$STATIC/'" $user
				else
					su -c "rsync -a '$STATIC/' '$LINK/'" $user
					su -c "touch '$LINK/.flagged'" $user
				fi
			else
				/bin/true
			fi
		done
	done
}

debug() {
	# sync profiles to tmpfs and back again
	local browser user
	for user in $USERS; do
		for browser in $BROWSERS; do
			set_which "$user" "$browser"
			echo $user:$homedir:$browser
		done
	done
}


check() {
	# crash recovery
	local browser user
	for user in $USERS; do
		for browser in $BROWSERS; do
			set_which "$user" "$browser"
			[[ -h $LINK ]] && rm -f -- "$LINK"
			[[ -d $STATIC ]] && mv "$STATIC" "$LINK"
		done
	done
}

unsync() {
	# restore virgin state of profiles on physical discs
	local browser user
	for user in $USERS; do
		for browser in $BROWSERS; do
			set_which "$user" "$browser"
			# check if user has browser profile
			if [[ -h $LINK ]]; then
				rm -f -- "$LINK"
				[[ -d $STATIC ]] && mv "$STATIC" "$LINK"
				[[ -d "$VOLATILE/$user-$browser" ]] && rm -rf -- "$VOLATILE/$user-$browser"
			fi
		done
	done
}

case "$1" in
	debug)
		debug
		;;
	check)
		# do not run if the daemon is running
		[[ ! -f /run/daemons/psd ]] && check
		;;
	sync)
		sync
		;;
	unsync)
		# make sure the daemon is running
		[[ -f /run/daemons/psd ]] && unsync
		;;
	*)
		# keep user from messing with this directly
		[[ -f /run/daemons/psd ]] && echo "You should not call this script directly, let the /etc/rc.d/psd do it for you!" && exit 1
esac
exit 0
